# Story 6.2: Deploy and Configure Metabase Application

## Status
Draft

## Story
**As a** Data Engineer,
**I want** to install Metabase and connect it to our BigQuery analytics views,
**so that** we can begin creating dashboards with our existing data.

## Acceptance Criteria
1. Metabase application deployed via Docker Compose with PostgreSQL backend successfully
2. BigQuery connection configured using service account with read access to analytics views
3. Initial Metabase admin user created and authentication working properly
4. All 4 analytics views (vw_monthly_finance, vw_productivity_metrics, vw_cost_allocation, vw_executive_summary) accessible through Metabase data browser
5. Sample dashboard created demonstrating BigQuery connectivity and query functionality
6. Metabase API access configured for programmatic dashboard management

## Tasks / Subtasks
- [ ] Deploy Metabase application (AC: 1)
  - [ ] Create Docker Compose configuration for Metabase and PostgreSQL
  - [ ] Deploy Metabase container with proper environment variables
  - [ ] Configure Metabase to use PostgreSQL as metadata database
  - [ ] Test Metabase web interface accessibility on port 3000

- [ ] Configure BigQuery data source (AC: 2, 4)
  - [ ] Add BigQuery connection in Metabase admin panel
  - [ ] Configure service account authentication for BigQuery access
  - [ ] Test connection to ai_usage_analytics dataset
  - [ ] Verify all 4 analytics views are accessible and queryable
  - [ ] Test sample queries from each view return expected data

- [ ] Setup Metabase administration (AC: 3, 6)
  - [ ] Create initial admin user account for system administration
  - [ ] Configure Metabase API access with authentication token
  - [ ] Test admin functions: user management, database connections, settings
  - [ ] Document admin credentials and API configuration

- [ ] Create sample dashboard validation (AC: 5)
  - [ ] Create sample Finance Executive dashboard using vw_monthly_finance
  - [ ] Add basic charts: monthly cost trends, platform distribution
  - [ ] Test dashboard functionality: filters, drill-downs, exports
  - [ ] Validate query performance meets 5-second target
  - [ ] Document dashboard creation process for replication

## Dev Notes

### Docker Compose Configuration
**Services Required:**
- **Metabase:** Latest stable version with BigQuery driver
- **PostgreSQL:** Version 13 for metadata storage
- **Nginx:** (Optional) For SSL termination and reverse proxy

**Environment Variables:**
```yaml
metabase:
  environment:
    MB_DB_TYPE: postgres
    MB_DB_DBNAME: metabase
    MB_DB_PORT: 5432
    MB_DB_USER: metabase
    MB_DB_PASS: secure_password
    MB_DB_HOST: postgres
```

### BigQuery Integration
**Service Account Configuration:**
- Use existing ai-usage-pipeline service account
- Ensure BigQuery Data Viewer role for analytics views
- Download service account JSON key for Metabase configuration

**Connection Parameters:**
- Project ID: Target GCP project
- Dataset: ai_usage_analytics
- Authentication: Service account JSON
- Driver: Google BigQuery (built into Metabase)

### Sample Dashboard Structure
**Finance Executive Dashboard:**
- Monthly cost trend line chart
- Platform cost distribution pie chart
- Top users by cost table
- Cost growth indicators

**Validation Queries:**
```sql
-- Test monthly finance data
SELECT month_year_label, platform, platform_monthly_cost
FROM vw_monthly_finance
WHERE cost_month >= DATE_SUB(CURRENT_DATE(), INTERVAL 6 MONTH)
ORDER BY cost_month DESC;

-- Test productivity metrics
SELECT month_year_label, user_email, monthly_lines_accepted, avg_monthly_acceptance_rate
FROM vw_productivity_metrics
WHERE usage_month >= DATE_SUB(CURRENT_DATE(), INTERVAL 3 MONTH)
ORDER BY monthly_lines_accepted DESC LIMIT 10;
```

## Testing
- Metabase must start successfully and respond on port 3000
- BigQuery connection must authenticate and query views successfully
- Sample dashboard must render data without errors
- API access must work for programmatic management

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| September 27, 2025 | 1.0 | Initial story creation for Metabase application deployment | John (PM) |

## Dev Agent Record
*[To be filled by development agent]*

## QA Results
*[To be filled by QA agent]*