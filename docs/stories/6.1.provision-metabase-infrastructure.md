# Story 6.1: Provision Metabase Infrastructure

## Status
Draft

## Story
**As a** DevOps Engineer,
**I want** to provision GCP Compute Engine VM with Docker and PostgreSQL,
**so that** we have the foundation for self-hosted Metabase deployment.

## Acceptance Criteria
1. GCP Compute Engine e2-medium VM provisioned with Ubuntu and Docker installed
2. PostgreSQL database configured for Metabase metadata storage with proper backup procedures
3. VM security configured with firewall rules allowing port 3000 access and SSH management
4. Automated backup scripts configured for both VM and PostgreSQL data protection
5. Monitoring configured for VM health, disk usage, and service availability

## Tasks / Subtasks
- [ ] Provision GCP Compute Engine VM (AC: 1)
  - [ ] Create e2-medium VM with Ubuntu 20.04 LTS in us-central1 region
  - [ ] Configure VM with 4GB RAM, 20GB persistent disk, and static external IP
  - [ ] Install Docker and Docker Compose on VM
  - [ ] Configure VM service account with BigQuery read access

- [ ] Setup PostgreSQL for Metabase (AC: 2)
  - [ ] Deploy PostgreSQL 13 via Docker container
  - [ ] Create metabase database and user with appropriate permissions
  - [ ] Configure PostgreSQL data persistence with Docker volumes
  - [ ] Test PostgreSQL connectivity and performance

- [ ] Configure VM security and access (AC: 3)
  - [ ] Create firewall rule allowing port 3000 (Metabase) from company IP ranges
  - [ ] Configure SSH access with key-based authentication
  - [ ] Disable password authentication and configure fail2ban
  - [ ] Set up VM-level monitoring and logging

- [ ] Implement backup and monitoring (AC: 4, 5)
  - [ ] Configure automated PostgreSQL backups to Cloud Storage
  - [ ] Set up VM snapshot backups with 7-day retention
  - [ ] Configure Cloud Monitoring for VM health, CPU, memory, disk usage
  - [ ] Create alerting policies for VM downtime and resource exhaustion

## Dev Notes

### VM Specifications
**Instance Type:** e2-medium (2 vCPUs, 4GB RAM)
**Operating System:** Ubuntu 20.04 LTS
**Disk:** 20GB persistent SSD
**Network:** Static external IP with firewall rules
**Location:** us-central1-a (same region as other GCP resources)

### Docker Configuration
**PostgreSQL Container:**
- Image: postgres:13
- Data volume: /var/lib/postgresql/data
- Port: 5432 (internal only)
- Environment: POSTGRES_DB=metabase, POSTGRES_USER=metabase

**Metabase Container:**
- Image: metabase/metabase:latest
- Port: 3000 (external access)
- Environment: Database connection to PostgreSQL

### Security Configuration
**Firewall Rules:**
- Allow port 3000 from company IP ranges
- Allow SSH (port 22) from admin IP ranges
- Deny all other inbound traffic

**Authentication:**
- SSH key-based authentication only
- VM service account with minimal BigQuery permissions
- No root login, dedicated metabase user

### Backup Strategy
**PostgreSQL Backups:**
- Daily automated backup to Cloud Storage
- 30-day retention policy
- Point-in-time recovery capability

**VM Snapshots:**
- Weekly VM snapshots
- 4-week retention policy
- Disaster recovery documentation

## Testing
- VM must boot successfully and accept SSH connections
- PostgreSQL must start and accept connections
- Docker containers must persist across VM reboots
- Backup procedures must execute without errors

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| September 27, 2025 | 1.0 | Initial story creation for Metabase infrastructure | John (PM) |

## Dev Agent Record
*[To be filled by development agent]*

## QA Results
*[To be filled by QA agent]*