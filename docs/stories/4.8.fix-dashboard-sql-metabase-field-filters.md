# Story 4.8: Fix Dashboard SQL Queries for Metabase Field Filter Syntax

Archon Project ID: cb4ceffa-9f56-4e05-9040-897c0a970a22
Archon Task ID: e38f5133-2abe-4091-beba-86018f3a4cb5
Update Protocol: Update Archon task status/comments and this file's Dev Agent Record
Status: To Do

## Story
**As a** Finance Team Member,
**I want** dashboard charts to render data correctly with working parameter filters,
**so that** I can analyze AI costs across different date ranges and budget scenarios.

## Background Context

Dashboard #10 "AI Cost Dashboard - Q4 2025" has been created with 14 cards and 6 parameters, but all charts show "There was a problem displaying this chart" errors.

**Root Cause Identified**: SQL queries use incorrect Metabase parameter syntax.

**Current (WRONG) Syntax**:
```sql
-- Using .start and .end accessors on date_range parameter
COALESCE({{date_range.start}}, DATE '2025-10-01') AS start_date
COALESCE({{date_range.end}}, DATE '2025-12-31') AS end_date
```

**Correct Metabase Syntax** (Field Filter):
```sql
-- Field Filter syntax (no operators, Metabase handles SQL generation)
WHERE {{cost_date_filter}}
```

**Evidence**:
- SQL queries work perfectly in BigQuery when tested directly
- Metabase logs show 500 errors on all card query executions
- Metabase Field Filter docs (Archon RAG source: d3c4a87567d085a4) confirm syntax requirements

## Acceptance Criteria

1. All 14 SQL query files rewritten to use Metabase Field Filter syntax for date filtering
2. Dashboard parameter changed from `date/all-options` type to Field Filter mapped to `cost_date` column
3. All 14 dashboard cards render data successfully (no error icons)
4. Date range filter interactively updates all charts when changed
5. Budget and alert threshold parameters work correctly with default values
6. Dashboard query performance < 5 seconds per card (performance target from Story 4.7)
7. Queries validated against actual BigQuery schema and data

## Critical Instructions for Dev Agent

### **BEFORE YOU START - VALIDATE DATA SOURCES**

1. **Check BigQuery Schema** - Don't assume, verify:
   ```bash
   bq query --project_id=ai-workflows-459123 --use_legacy_sql=false "
   SELECT column_name, data_type
   FROM \`ai_usage_analytics.INFORMATION_SCHEMA.COLUMNS\`
   WHERE table_name = 'vw_combined_daily_costs'
   ORDER BY ordinal_position
   "
   ```

2. **Verify Provider Values** - Check actual data:
   ```bash
   bq query --project_id=ai-workflows-459123 --use_legacy_sql=false "
   SELECT DISTINCT provider
   FROM \`ai_usage_analytics.vw_combined_daily_costs\`
   "
   ```

   Expected values: `claude_api`, `claude_code`, `cursor` (NOT claude.ai, NOT claude-api)

3. **Sample Data Validation**:
   ```bash
   bq query --project_id=ai-workflows-459123 --use_legacy_sql=false "
   SELECT * FROM \`ai_usage_analytics.vw_combined_daily_costs\`
   LIMIT 5
   "
   ```

4. **Use Archon RAG for Metabase Docs**:
   ```python
   # Search Metabase documentation in Archon
   mcp__archon__rag_search_knowledge_base(
     query="field filter SQL WHERE",
     source_id="d3c4a87567d085a4",  # Metabase docs
     match_count=5
   )
   ```

### **METABASE FIELD FILTER SYNTAX RULES**

**From Metabase Documentation** (verified via Archon RAG):

**Rule 1**: Use Field Filter syntax without operators
```sql
-- WRONG
WHERE cost_date >= {{start_date}} AND cost_date <= {{end_date}}

-- CORRECT
WHERE {{cost_date_filter}}
```

**Rule 2**: Map Field Filter to a table column
- Variable type: "Field Filter"
- Field to map to: `ai_usage_analytics.vw_combined_daily_costs` → `cost_date`
- Widget type: "Date Range" or "All Options"

**Rule 3**: For optional filters, use bracket syntax
```sql
-- Makes the WHERE clause optional
SELECT *
FROM table
[[WHERE {{date_filter}}]]
```

**Rule 4**: Don't access .start or .end properties
- Field Filters generate complete SQL automatically
- No need for COALESCE or default dates
- Metabase handles NULL/missing parameter values

## Tasks / Subtasks

- [ ] **Validate BigQuery Schema and Data** (AC: 7)
  - [ ] Run schema query for `vw_combined_daily_costs`
  - [ ] Verify column names: `cost_date`, `provider`, `amount_usd`, `user_email`, etc.
  - [ ] Check actual provider values in data (should be: claude_api, claude_code, cursor)
  - [ ] Test sample query to understand data structure
  - [ ] Document any schema mismatches found

- [ ] **Research Metabase Field Filter Syntax** (Use Archon RAG)
  - [ ] Search Archon: `rag_search_knowledge_base(query="field filter", source_id="d3c4a87567d085a4")`
  - [ ] Find official Metabase docs on Field Filter WHERE clause syntax
  - [ ] Understand how to map filters to date columns
  - [ ] Learn how Field Filters handle optional parameters
  - [ ] Review examples of working date range filters

- [ ] **Rewrite SQL Query Files** (AC: 1)
  - [ ] Update all 14 files in `sql/dashboard/ai_cost/`:
    - `01_kpi_total_cost.sql` through `14_alert_utilization.sql`
  - [ ] Replace `COALESCE({{date_range.start}}, ...)` pattern with Field Filter
  - [ ] Change WHERE clause to: `[[WHERE {{cost_date_filter}}]]`
  - [ ] Keep budget parameter references: `{{quarter_budget_usd}}`, `{{daily_budget_usd}}`, etc.
  - [ ] Remove `params` CTE (no longer needed for date defaults)
  - [ ] Test each query in BigQuery before saving

- [ ] **Update Dashboard Creator Script** (AC: 2)
  - [ ] Modify `scripts/metabase/create_dashboards.py`
  - [ ] Change parameter creation from `date/all-options` to Field Filter type
  - [ ] Update template tag generation to include field mapping
  - [ ] Ensure parameter mappings bind filter to `cost_date` column
  - [ ] Keep number parameters unchanged (they work fine)

- [ ] **Delete Old Dashboard and Recreate** (AC: 3, 4)
  - [ ] Delete Dashboard #10 (has broken queries)
  - [ ] Run updated dashboard creator script
  - [ ] Verify all 14 cards created successfully
  - [ ] Check that cards have proper parameter mappings
  - [ ] Confirm dashboard ID and URL

- [ ] **Test Dashboard Functionality** (AC: 4, 5, 6)
  - [ ] Load dashboard in browser
  - [ ] Verify all 14 cards display data (no error icons)
  - [ ] Test date range filter - all cards should update
  - [ ] Test budget parameters - KPIs should recalculate
  - [ ] Measure query performance (should be < 5s per card)
  - [ ] Screenshot working dashboard for documentation

## Technical Details

### Current BigQuery Schema (Verified October 19, 2025)

**View**: `ai_usage_analytics.vw_combined_daily_costs`

**Columns**:
```
cost_date (DATE) - PRIMARY FILTER COLUMN
provider (STRING) - Values: 'claude_api', 'claude_code', 'cursor'
cost_category (STRING)
workspace_id (STRING)
user_email (STRING)
api_key_id (INT64)
model (STRING)
description (STRING)
amount_usd (NUMERIC)
ingestion_timestamp (TIMESTAMP)
source_table (STRING)
```

**Data Stats** (as of Oct 19, 2025):
- Total rows: 1,771
- Date range: June 1 → October 17, 2025
- Total cost (Q4): $35,738.88
  - claude_api: $26,331.61
  - claude_code: $7,965.00
  - cursor: $1,442.27

### Example SQL Transformation

**BEFORE (Current - BROKEN)**:
```sql
-- sql/dashboard/ai_cost/01_kpi_total_cost.sql
WITH params AS (
  SELECT
    COALESCE({{date_range.start}}, DATE '2025-10-01') AS start_date,
    COALESCE({{date_range.end}}, DATE '2025-12-31') AS end_date
),
filtered AS (
  SELECT c.*
  FROM params p
  JOIN `ai_usage_analytics.vw_combined_daily_costs` c
    ON c.cost_date BETWEEN p.start_date AND p.end_date
)
SELECT
  ROUND(SUM(amount_usd), 2) AS total_cost_usd,
  ROUND(SUM(IF(provider = 'claude_api', amount_usd, 0)), 2) AS claude_api_cost_usd,
  ROUND(SUM(IF(provider = 'claude_code', amount_usd, 0)), 2) AS claude_code_cost_usd,
  ROUND(SUM(IF(provider = 'cursor', amount_usd, 0)), 2) AS cursor_cost_usd
FROM filtered;
```

**AFTER (Fixed - WORKING)**:
```sql
-- sql/dashboard/ai_cost/01_kpi_total_cost.sql
SELECT
  ROUND(SUM(amount_usd), 2) AS total_cost_usd,
  ROUND(SUM(IF(provider = 'claude_api', amount_usd, 0)), 2) AS claude_api_cost_usd,
  ROUND(SUM(IF(provider = 'claude_code', amount_usd, 0)), 2) AS claude_code_cost_usd,
  ROUND(SUM(IF(provider = 'cursor', amount_usd, 0)), 2) AS cursor_cost_usd
FROM `ai_usage_analytics.vw_combined_daily_costs`
[[WHERE {{cost_date_filter}}]];
```

**Key Changes**:
1. ✅ Removed `params` CTE entirely
2. ✅ Removed `filtered` CTE
3. ✅ Direct query on view
4. ✅ Added `[[WHERE {{cost_date_filter}}]]` (optional Field Filter)
5. ✅ Brackets `[[ ]]` make WHERE clause optional (won't break if no date selected)

### Dashboard Creator Updates Needed

**File**: `scripts/metabase/create_dashboards.py`

**Change parameter creation** from:
```python
# WRONG - date/all-options type
params.append({
    "id": f"mb_param_{slug}",
    "name": "date_range",
    "slug": "date_range",
    "type": "date/all-options",
    "default": None,
    "_widget": "date/all-options",
})
```

**To**:
```python
# CORRECT - Field Filter type
params.append({
    "id": f"mb_param_cost_date_filter",
    "name": "cost_date_filter",
    "slug": "cost_date_filter",
    "type": "dimension",  # Field Filter type
    "target": ["dimension", ["field", "cost_date", {"base-type": "type/Date"}]],
    "default": None,
    "_widget": "date/all-options",
})
```

### Files to Modify

**SQL Query Files** (14 files):
1. `sql/dashboard/ai_cost/01_kpi_total_cost.sql`
2. `sql/dashboard/ai_cost/02_kpi_daily_average.sql`
3. `sql/dashboard/ai_cost/03_kpi_cost_per_user.sql`
4. `sql/dashboard/ai_cost/04_kpi_budget_variance.sql`
5. `sql/dashboard/ai_cost/05_daily_spend_trend.sql`
6. `sql/dashboard/ai_cost/06_tool_breakdown.sql`
7. `sql/dashboard/ai_cost/07_top15_spenders.sql`
8. `sql/dashboard/ai_cost/08_user_distribution_histogram.sql`
9. `sql/dashboard/ai_cost/09_cost_by_model.sql`
10. `sql/dashboard/ai_cost/10_cost_by_token_type.sql`
11. `sql/dashboard/ai_cost/11_team_attribution_table.sql`
12. `sql/dashboard/ai_cost/12_alert_budget.sql`
13. `sql/dashboard/ai_cost/13_alert_efficiency.sql`
14. `sql/dashboard/ai_cost/14_alert_utilization.sql`

**Script Files** (1 file):
- `scripts/metabase/create_dashboards.py` - Parameter creation logic

### Testing Requirements

**Before recreating dashboard**:
1. Test each modified SQL query directly in BigQuery
2. Verify query returns expected results
3. Check performance (should be < 2 seconds in BigQuery)

**After dashboard recreation**:
1. Verify all 14 cards render without errors
2. Test date filter changes all cards
3. Test budget parameter changes affect KPIs
4. Export one card to CSV to verify data correctness
5. Measure dashboard load time (target: < 5 seconds)

### Reference Data Sources

**BigQuery Project**: `ai-workflows-459123`
**Dataset**: `ai_usage_analytics`
**Primary View**: `vw_combined_daily_costs`

**Data Available** (verified Oct 19, 2025):
- 1,771 cost records
- Date range: June 1 → October 17, 2025
- 3 providers: claude_api, claude_code, cursor
- All queries tested and working in BigQuery CLI

**Archon RAG Resources**:
- Metabase Documentation: Source ID `d3c4a87567d085a4`
- Query for help: `rag_search_knowledge_base(query="...", source_id="d3c4a87567d085a4")`

**Metabase Instance**:
- URL: http://34.41.65.168:3000
- Database ID: 2 - "AI Usage Analytics (BigQuery)"
- Current Dashboard: #10 (to be recreated)
- Admin: sid.dani@samba.tv

## Coordination

- Epic: 4 (Metabase Dashboard Suite)
- Depends on: Stories 4.1 (Metabase provisioned), 4.2 (BigQuery connected), 4.3 (Dashboard infrastructure)
- Blocks: Stories 4.4, 4.5 (additional dashboards should use same pattern)
- Related: Story 3.1 (BigQuery views created)

## Dev Notes

### Why Field Filters Instead of SQL Variables?

**From Metabase Documentation** (Archon source d3c4a87567d085a4):

> "Field Filters are a special type of variable that map the variable to a field (or column) in a table. The SQL code around Field Filters is not exactly street legal. You may be tempted to write: `WHERE category = {{ category }}` because that is the correct syntax for a WHERE clause in standard SQL. But that syntax won't work for Field Filters."

**Benefits of Field Filters**:
1. Automatic SQL generation for complex scenarios
2. Handles multiple selections without manual OR logic
3. Supports all date filter widget types (range, relative, specific)
4. Properly integrates with dashboard parameter linking
5. No need for COALESCE or default value CTEs

### Pattern for All Queries

**Standard pattern** to apply to all 14 SQL files:

```sql
-- Remove params CTE
-- Remove filtered CTE
-- Query directly on view with Field Filter

SELECT
  -- aggregations and calculations here
FROM `ai_usage_analytics.vw_combined_daily_costs`
[[WHERE {{cost_date_filter}}]]
GROUP BY ...
ORDER BY ...;
```

**For queries using budget parameters**:
```sql
-- Budget parameters stay as-is (number type works fine)
SELECT
  total_cost,
  {{daily_budget_usd}} as budget,
  total_cost - {{daily_budget_usd}} as variance
FROM `ai_usage_analytics.vw_combined_daily_costs`
[[WHERE {{cost_date_filter}}]]
```

### Common Pitfalls to Avoid

1. **Don't use `.start` or `.end`** - Field Filters don't have accessors
2. **Don't add `=` operator** - Field Filter handles it
3. **Do use `[[ ]]` brackets** - Makes WHERE clause optional
4. **Do test in BigQuery first** - Remove `{{...}}` placeholders for testing
5. **Do verify provider names** - Use actual values from data, not assumed names

### Dashboard Creator Modifications

**Current parameter creation** (line ~215):
```python
# This creates wrong type
if "date" in p:
    params.append({
        "id": f"mb_param_{slug}",
        "name": p,
        "slug": p,
        "type": "date/all-options",  # WRONG TYPE
        "default": None,
        "_widget": "date/all-options",
    })
```

**Updated parameter creation**:
```python
# Create Field Filter for date
if "cost_date_filter" == p or "date_filter" in p:
    params.append({
        "id": f"mb_param_{slug}",
        "name": p,
        "slug": p,
        "type": "dimension",  # Field Filter type
        "target": ["dimension", ["field", "cost_date", {"base-type": "type/Date"}]],
        "default": None,
        "_widget": "date/all-options",
    })
```

**Then update dashboard creation call**:
```bash
python3 create_dashboards.py \
  --sql-dir sql/dashboard/ai_cost \
  --dashboard-name "AI Cost Dashboard - Q4 2025" \
  --field-filter cost_date_filter \  # NEW: Field filter instead of --param date_range
  --number quarter_budget_usd=73000 \
  --number daily_budget_usd=793.48 \
  --number alert_threshold_usd=500 \
  --number inactive_window_days=14 \
  --number total_seats=250 \
  --out dashboards.json
```

## Execution Checklist

### Phase 1: Research & Validation (30 min)

1. ✅ Query BigQuery schema for `vw_combined_daily_costs`
2. ✅ Verify actual column names and types
3. ✅ Check provider values in data
4. ✅ Search Archon RAG for Metabase Field Filter docs
5. ✅ Read and understand Field Filter syntax rules
6. ✅ Test one example query manually in BigQuery

### Phase 2: Fix SQL Files (1 hour)

1. ✅ Create backup of current SQL files
2. ✅ Rewrite queries following Field Filter pattern
3. ✅ Remove `params` and `filtered` CTEs
4. ✅ Add `[[WHERE {{cost_date_filter}}]]`
5. ✅ Keep budget parameter usage unchanged
6. ✅ Test each modified query in BigQuery (remove {{...}} for testing)
7. ✅ Commit SQL file changes

### Phase 3: Update Dashboard Creator (30 min)

1. ✅ Modify parameter creation logic in `create_dashboards.py`
2. ✅ Add support for `--field-filter` argument
3. ✅ Update template tag generation for Field Filters
4. ✅ Test script syntax (run with --help)
5. ✅ Commit script changes

### Phase 4: Deploy to Metabase VM (30 min)

1. ✅ SSH to metabase-vm
2. ✅ Pull latest code from GitHub
3. ✅ Copy updated files to `/tmp/metabase-assets/sql/dashboard/ai_cost/`
4. ✅ Copy updated script to `/opt/metabase/tools/`
5. ✅ Delete Dashboard #10
6. ✅ Run dashboard creator script
7. ✅ Verify new dashboard created

### Phase 5: Validation & Testing (30 min)

1. ✅ Open dashboard in browser
2. ✅ Verify all 14 cards render data
3. ✅ Test date range filter interaction
4. ✅ Test budget parameter changes
5. ✅ Measure query performance
6. ✅ Export one card to CSV
7. ✅ Screenshot success state
8. ✅ Update story file with completion notes

## Expected Results

**Dashboard URL**: http://34.41.65.168:3000/dashboard/[NEW_ID]

**KPI Cards Should Show**:
- Total Cost: ~$35,738 (based on current data through Oct 17)
- Claude API: ~$26,331
- Claude Code: ~$7,965
- Cursor: ~$1,442

**Charts Should Display**:
- Daily Spend Trend: Line chart with budget reference line
- Tool Breakdown: Pie chart showing 3 providers
- Top 15 Spenders: Bar chart (if user_email populated)
- All other visualizations with real data

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| October 19, 2025 | 1.0 | Initial story creation for dashboard SQL fix | Winston (Architect) |

## Dev Agent Record

### Assigned To
Dev Agent (to be assigned)

### Resources Available

**Archon RAG Access**:
```python
# Metabase documentation
mcp__archon__rag_search_knowledge_base(
  query="your search terms",
  source_id="d3c4a87567d085a4",
  match_count=5
)
```

**BigQuery Access**:
- Full access to `ai-workflows-459123` project
- Dataset: `ai_usage_analytics`
- Use `bq query` for validation

**Metabase VM**:
- SSH: `gcloud compute ssh metabase-vm --zone=us-central1-c`
- Tools: `/opt/metabase/tools/`
- SQL Assets: `/tmp/metabase-assets/sql/dashboard/`

### Completion Evidence Required

1. Screenshot of working dashboard with all 14 cards rendering
2. Video/GIF of date filter changing chart data
3. BigQuery query logs showing < 5s execution times
4. Exported CSV sample from one card
5. Git commit showing all SQL file changes

## QA Results

(To be filled after implementation)

### Success Criteria for QA

- All 14 cards render without errors ✓
- Date range filter changes all visualizations ✓
- Budget parameters update KPIs correctly ✓
- Query performance < 5 seconds ✓
- Data matches BigQuery test queries ✓
