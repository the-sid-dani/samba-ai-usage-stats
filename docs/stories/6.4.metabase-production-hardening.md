# Story 6.4: Metabase Production Hardening and Documentation

## Status
Ready for Review

## Story
**As a** System Administrator,
**I want** comprehensive operational procedures and automated management for the Metabase platform,
**so that** the system operates reliably with minimal manual intervention.

## Acceptance Criteria
1. Automated backup procedures implemented for VM, PostgreSQL, and Metabase configurations
2. Monitoring and alerting configured for VM health, application status, and dashboard availability
3. Operational documentation created covering VM management, Metabase administration, and troubleshooting
4. User management procedures documented for finance team access and role assignment
5. Dashboard-as-code implementation using Metabase API for reproducible dashboard deployment
6. Performance optimization completed ensuring system handles expected user load and query volume

## Tasks / Subtasks
- [ ] Implement comprehensive backup system (AC: 1)
  - [ ] Configure automated PostgreSQL database backups to Cloud Storage
  - [ ] Set up VM disk snapshots with retention policies
  - [ ] Create Metabase configuration backup (settings, dashboards, users)
  - [ ] Document backup restoration procedures and test recovery process
  - [ ] Schedule regular backup validation and integrity checks

- [ ] Configure monitoring and alerting (AC: 2)
  - [ ] Set up Cloud Monitoring for VM metrics (CPU, memory, disk, network)
  - [ ] Configure Metabase application health monitoring
  - [ ] Create alerting policies for VM downtime, resource exhaustion, application failures
  - [ ] Set up dashboard availability monitoring with response time tracking
  - [ ] Configure notification channels for operations team

- [ ] Create operational documentation (AC: 3)
  - [ ] Document VM administration procedures: updates, patches, restarts
  - [ ] Create Metabase administration guide: user management, dashboard creation, API usage
  - [ ] Build troubleshooting runbook for common issues and resolution steps
  - [ ] Document performance tuning procedures for VM and PostgreSQL
  - [ ] Create disaster recovery procedures with step-by-step restoration guide

- [ ] Establish user management procedures (AC: 4)
  - [ ] Create finance team user accounts with appropriate permissions
  - [ ] Configure role-based access: Finance (read), Engineering (read), Admin (full)
  - [ ] Document user onboarding and offboarding procedures
  - [ ] Set up user activity auditing and access logging
  - [ ] Create procedures for password resets and account management

- [ ] Implement dashboard-as-code (AC: 5)
  - [ ] Create Python scripts using Metabase API for dashboard automation
  - [ ] Build dashboard configuration templates for reproducible deployment
  - [ ] Implement version control for dashboard definitions
  - [ ] Create automated dashboard deployment and update procedures
  - [ ] Test dashboard recreation from code for disaster recovery scenarios

- [ ] Performance optimization and load testing (AC: 6)
  - [ ] Optimize PostgreSQL configuration for Metabase workload
  - [ ] Tune VM resources and Docker container settings
  - [ ] Perform load testing with expected user count and query patterns
  - [ ] Optimize BigQuery connections and query caching
  - [ ] Document performance baselines and scaling recommendations

## Dev Notes

### Backup Architecture
**Three-Tier Backup Strategy:**
1. **Application Level:** Metabase configuration and dashboard exports
2. **Database Level:** PostgreSQL dumps with point-in-time recovery
3. **Infrastructure Level:** VM snapshots for complete system recovery

**Backup Schedule:**
- **Daily:** PostgreSQL database backup
- **Weekly:** VM snapshot and Metabase configuration backup
- **Monthly:** Full system backup with validation testing

### Monitoring Strategy
**VM Level Monitoring:**
- CPU usage (alert >80% sustained)
- Memory usage (alert >85%)
- Disk usage (alert >75%)
- Network connectivity and response time

**Application Level Monitoring:**
- Metabase process health and responsiveness
- Dashboard query performance and error rates
- User session activity and authentication success
- API endpoint availability and response times

### Dashboard-as-Code Implementation
**Metabase API Integration:**
```python
# Example dashboard creation via API
import requests

metabase_api = "http://metabase-vm:3000/api"
headers = {"X-Metabase-Session": "session_token"}

# Create dashboard
dashboard_config = {
    "name": "Finance Executive Dashboard",
    "description": "Monthly cost summaries and trends",
    "parameters": [],
    "cards": [...]
}

response = requests.post(f"{metabase_api}/dashboard",
                        json=dashboard_config, headers=headers)
```

**Version Control Strategy:**
- Dashboard definitions stored as JSON in version control
- Automated deployment scripts for dashboard updates
- Change tracking and rollback capabilities

### Performance Optimization
**PostgreSQL Tuning:**
- Connection pooling for concurrent users
- Query optimization for Metabase metadata operations
- Memory allocation tuning for VM workload

**Metabase Configuration:**
- BigQuery connection pooling
- Query result caching for improved response times
- Resource allocation optimization for concurrent dashboard usage

## Testing
- All backup procedures must execute successfully and be validated
- Monitoring must detect and alert on various failure scenarios
- Dashboard-as-code deployment must recreate dashboards identically
- Performance optimization must achieve 5-second query target

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| September 27, 2025 | 1.0 | Initial story creation for Metabase production hardening | John (PM) |

## Dev Agent Record
*[To be filled by development agent]*

## QA Results
*[To be filled by QA agent]*